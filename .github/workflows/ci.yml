name: C Calculator CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install build dependencies (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential

      - name: Install build dependencies (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          choco install cmake -y

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Build Project
        run: |
          echo "=== 跨平台构建 ==="
          mkdir build && cd build
          cmake ..
          cmake --build . --config Release
          
          echo "=== 构建产物检查 ==="
          find . -name "*.so" -o -name "*.dll" | while read file; do
            echo "📦 找到: $file"
          done
          
          cd ..
          mkdir -p lib
          find build -name "*.so" -exec cp {} lib/ \; 2>/dev/null || true
          find build -name "*.dll" -exec cp {} lib/ \; 2>/dev/null || true

      - name: Verify library files
        run: |
          echo "=== 最终库文件验证 ==="
          ls -la lib/ 2>/dev/null || echo "lib 目录不存在"
          if [ $(find lib -name "*.so" -o -name "*.dll" 2>/dev/null | wc -l) -eq 0 ]; then
            echo "❌ 没有生成库文件"
            exit 1
          else
            echo "✅ 库文件生成成功"
          fi

      - name: Run Python interface tests
        run: |
          cd calculator_tests
          python test_interfaces.py --verbose
        env:
          PYTHONIOENCODING: utf-8
