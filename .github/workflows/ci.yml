name: Calculator CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  windows-msvc:
    name: Windows MSVC
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create build directory
        run: mkdir build

      - name: Configure with CMake (MSVC)
        run: |
          cd build
          cmake .. -G "Visual Studio 17 2022" -A x64
        env:
          GITHUB_ACTIONS: "true"

      - name: Build project (MSVC)
        run: |
          cd build
          cmake --build . --config Release

      - name: Validate build (MSVC)
        run: |
          cd build
          cmake --build . --target validate_all

      - name: List generated files (MSVC)
        run: |
          cd build
          dir /B /S *.exe *.dll

  windows-mingw:
    name: Windows MinGW
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install MinGW (Simplified)
        run: |
          # 使用更简单的方式安装 MinGW
          curl -L -o mingw.7z "https://github.com/niXman/mingw-builds-binaries/releases/download/15.2.0-rt_v13-rev0/x86_64-15.2.0-release-posix-seh-ucrt-rt_v13-rev0.7z"
          7z x mingw.7z -oC:\mingw
          echo "C:\mingw\mingw64\bin" >> $GITHUB_PATH

      - name: Verify MinGW installation
        run: |
          gcc --version
          g++ --version

      - name: Create build directory
        run: mkdir build

      - name: Configure with CMake (MinGW)
        run: |
          cd build
          cmake .. -G "MinGW Makefiles"
        env:
          GITHUB_ACTIONS: "true"
          TEST_BUILD: "1"

      - name: Build project (MinGW)
        run: |
          cd build
          cmake --build .

      - name: Validate build (MinGW)
        run: |
          cd build
          cmake --build . --target validate_all

      - name: List generated files (MinGW)
        run: |
          cd build
          dir /B /S *.exe *.dll

  linux-gcc:
    name: Linux GCC
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake

      - name: Create build directory
        run: mkdir build

      - name: Configure with CMake (GCC)
        run: |
          cd build
          cmake .. -G "Unix Makefiles"
        env:
          GITHUB_ACTIONS: "true"
          TEST_BUILD: "1"

      - name: Build project (GCC)
        run: |
          cd build
          cmake --build .

      - name: Validate build (GCC)
        run: |
          cd build
          cmake --build . --target validate_all

      - name: List generated files (GCC)
        run: |
          cd build
          find . -name "*.so" -o -name "calculator_app*" -type f

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [windows-msvc, windows-mingw, linux-gcc]
    if: always()

    steps:
      - name: Display test results
        run: |
          echo "=== Build Test Results ==="
          echo "Windows MSVC: ${{ needs.windows-msvc.result }}"
          echo "Windows MinGW: ${{ needs.windows-mingw.result }}"
          echo "Linux GCC: ${{ needs.linux-gcc.result }}"
          echo "=========================="