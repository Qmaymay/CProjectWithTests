name: C Calculator CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # ç¬¬ä¸€ä¸ªä»»åŠ¡ï¼šå®‰å…¨æ‰«æï¼ˆå¹¶è¡Œæ‰§è¡Œï¼Œä¸é˜»å¡æ„å»ºï¼‰
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Basic security checks
        run: |
          echo "ğŸ”’ åŸºç¡€å®‰å…¨æ‰«æ..."
          # æ£€æŸ¥æ˜¯å¦ä¸å°å¿ƒæäº¤äº†å¯†ç ã€å¯†é’¥ç­‰æ•æ„Ÿä¿¡æ¯
          if git log -p | grep -i "password\|secret\|key" | head -5; then
            echo "âš ï¸  æ£€æµ‹åˆ°å¯èƒ½çš„æ•æ„Ÿä¿¡æ¯"
          else
            echo "âœ… æœªå‘ç°æ•æ„Ÿä¿¡æ¯"
          fi
          
          # æ£€æŸ¥Cä»£ç ä¸­ä¸å®‰å…¨å‡½æ•°
          echo "ğŸ” æ‰«æCä»£ç å®‰å…¨é—®é¢˜..."
          find calculator -name "*.c" -exec grep -l "strcpy\|gets\|sprintf" {} \; | head -5 || echo "âœ… æœªå‘ç°ä¸å®‰å…¨å‡½æ•°"

  # ç¬¬äºŒä¸ªä»»åŠ¡ï¼šæ„å»ºå’Œæµ‹è¯•ï¼ˆè·¨å¹³å°ï¼‰
  build-and-test:
    name: Build and Test
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        include:
          - os: ubuntu-latest
            build-dir: build_linux
          - os: windows-latest
            build-dir: build_windows

    steps:
      # ç¬¬1æ­¥ï¼šè·å–ä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4

      # ç¬¬2æ­¥ï¼šå®‰è£…å·¥å…·ï¼ˆåˆ†ç³»ç»Ÿï¼‰
      - name: Install build dependencies (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake gcc python3 python3-pip build-essential

      - name: Install build dependencies (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          choco install mingw -y

      # ç¬¬3æ­¥ï¼šè®¾ç½®Pythonç¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # ç¬¬4æ­¥ï¼šé…ç½®CMake
      - name: Configure CMake
        run: cmake -B ${{ matrix.build-dir }} -S calculator
        env:
          CMAKE_BUILD_TYPE: Release

      # ç¬¬5æ­¥ï¼šç¼–è¯‘é¡¹ç›®
      - name: Build project
        run: cmake --build ${{ matrix.build-dir }} --config Release

      # ç¬¬6æ­¥ï¼šè¿è¡Œæµ‹è¯•
      - name: Run Python interface tests
        run: |
#          cmd /c "chcp 65001 > nul"
          mkdir ..\lib
          copy calculator\build_windows\Release\calculator.dll ..\lib\
          copy calculator\build_windows\Release\calculator_app.exe ..\lib\
          cd calculator_tests
          echo "=== è¿è¡Œæ¥å£æµ‹è¯• ==="  
          python test_interfaces.py --verbose
        env:
          PYTHONIOENCODING: utf-8

      # ç¬¬7æ­¥ï¼šæ˜¾ç¤ºæ„å»ºäº§ç‰©ä¿¡æ¯
      - name: Build artifacts info
        run: |
          echo "=== æ„å»ºäº§ç‰©ä¿¡æ¯ ==="
          find . -name "*.so" -o -name "*.dll" -o -name "*.exe" | while read file; do
            echo "ğŸ“¦ $(basename "$file"): $(dirname "$file")"
            if command -v file &> /dev/null; then
              file "$file" || true
            fi
          done

      # ç¬¬8æ­¥ï¼šæ‰“åŒ…æˆå“ï¼ˆåªæœ‰æµ‹è¯•é€šè¿‡æ‰æ‰§è¡Œï¼‰
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: calculator-${{ matrix.os }}
          path: |
            lib/
            */build/
          retention-days: 7