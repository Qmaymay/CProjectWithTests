name: C Calculator CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install build dependencies (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential

      - name: Install build dependencies (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          choco install cmake -y

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Build Project
        run: |
          echo "=== 跨平台构建 ==="

          # 创建构建目录
          mkdir build && cd build

          # 配置项目
          cmake ..

          # 构建项目
          cmake --build . --config Release

          # 回到根目录
          cd ..

          # 创建 lib 目录
          mkdir -p lib

          # 简单的文件复制（让CMake处理输出位置）
          echo "=== 复制库文件 ==="

          # 尝试从不同位置复制库文件
          cp build/calculator/*.dll lib/ 2>/dev/null || true
          cp build/calculator/*.so lib/ 2>/dev/null || true
          cp build/*.dll lib/ 2>/dev/null || true
          cp build/*.so lib/ 2>/dev/null || true
          cp build/lib/*.dll lib/ 2>/dev/null || true
          cp build/lib/*.so lib/ 2>/dev/null || true

      - name: Verify library files
        run: |
          echo "=== 最终库文件验证 ==="
          echo "lib 目录内容:"

          # 使用 find 命令，它在两个平台都可用（Windows 有 find.exe）
          find lib -name "*.so" -o -name "*.dll" 2>/dev/null | while read file; do
            echo "📦 找到库文件: $file"
          done

          # 检查是否找到任何库文件
          if find lib -name "*.so" -o -name "*.dll" 2>/dev/null | grep -q .; then
            echo "✅ 库文件生成成功"
          else
            echo "❌ 没有生成库文件"
            echo "当前目录结构:"
            find . -name "*.so" -o -name "*.dll" | head -10
            exit 1
          fi
          

      - name: Run Python interface tests
        run: |
          cd calculator_tests
          python test_interfaces.py --verbose
        env:
          PYTHONIOENCODING: utf-8
