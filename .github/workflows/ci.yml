name: C Calculator CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  build-and-test:
    name: Build and Test (${{ matrix.os }} - ${{ matrix.build_type }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        build_type: [Release, Debug]
        exclude:
          - os: windows-latest
            build_type: Debug

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install build dependencies (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential

      - name: Install build dependencies (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          choco install cmake -y

      - name: Install build dependencies (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          brew update
          brew install cmake

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Build Project
        run: |
          echo "=== 构建项目 ==="
          echo "操作系统: ${{ matrix.os }}"
          echo "构建类型: ${{ matrix.build_type }}"
          
          # 清理并创建构建目录
          rm -rf build lib
          mkdir build && cd build
          
          # 配置和构建
          cmake -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} ..
          cmake --build . --config ${{ matrix.build_type }}
          
          cd ..
          
          # 创建库目录并复制构建产物
          mkdir -p lib
          if [ "${{ matrix.os }}" == "windows-latest" ]; then
            # Windows: 复制 DLL 和 EXE 文件
            find build -name "*.dll" -exec cp {} lib/ \; 2>/dev/null || echo "无DLL文件"
            find build -name "*.exe" -exec cp {} lib/ \; 2>/dev/null || echo "无可执行文件"
          else
            # Linux/macOS: 复制 SO/DYLIB 和可执行文件
            find build -name "*.so" -exec cp {} lib/ \; 2>/dev/null || echo "无SO文件"
            find build -name "*.dylib" -exec cp {} lib/ \; 2>/dev/null || echo "无DYLIB文件"
            find build -name "calculator_app" -exec cp {} lib/ \; 2>/dev/null || echo "无可执行文件"
          fi

      - name: Test Executable
        run: |
          echo "=== 测试可执行文件 ==="
          if [ "${{ matrix.os }}" == "windows-latest" ]; then
            if [ -f "lib/calculator_app.exe" ]; then
              echo "✅ 找到可执行文件，运行测试..."
              cd lib && ./calculator_app.exe
              echo "可执行文件测试完成"
            else
              echo "❌ 未找到可执行文件"
              echo "当前目录内容:"
              ls -la
              echo "lib目录内容:"
              ls -la lib/ || echo "lib目录不存在"
            fi
          else
            if [ -f "lib/calculator_app" ]; then
              echo "✅ 找到可执行文件，运行测试..."
              cd lib && ./calculator_app
              echo "可执行文件测试完成"
            else
              echo "❌ 未找到可执行文件"
              echo "当前目录内容:"
              ls -la
              echo "lib目录内容:"
              ls -la lib/ || echo "lib目录不存在"
            fi
          fi

      - name: Run Python interface tests
        run: |
          echo "=== 运行Python接口测试 ==="
          cd calculator_tests
          python test_interfaces.py --verbose
        env:
          PYTHONIOENCODING: utf-8

      - name: Run Comprehensive Tests
        run: |
          echo "=== 运行综合测试 ==="
          cd calculator_tests
          python main.py --all

      - name: Build Summary
        run: |
          echo "=== 构建总结 ==="
          echo "平台: ${{ matrix.os }}"
          echo "构建类型: ${{ matrix.build_type }}"
          echo "构建时间: $(date)"
          echo "库文件列表:"
          ls -la lib/ 2>/dev/null || echo "lib目录不存在或为空"
          echo "======================"