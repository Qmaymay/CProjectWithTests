name: C Calculator CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  build-and-test:
    name: Build and Test (${{ matrix.os }} - ${{ matrix.compiler }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        compiler: [default, mingw]
        exclude:
          - os: ubuntu-latest
            compiler: mingw
        include:
          - os: ubuntu-latest
            compiler: gcc

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install build dependencies (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential

      - name: Install build dependencies (Windows - MinGW)
        if: matrix.os == 'windows-latest' && matrix.compiler == 'mingw'
        run: |
          choco install mingw cmake -y

      - name: Install build dependencies (Windows - MSVC)
        if: matrix.os == 'windows-latest' && matrix.compiler == 'default'
        run: |
          choco install cmake -y

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Build Project
        run: |
          echo "=== 构建项目 ==="
          echo "操作系统: ${{ matrix.os }}"
          echo "编译器: ${{ matrix.compiler }}"
          
          # 清理
          if [ "${{ matrix.os }}" == "windows-latest" ]; then
            if exist build rmdir /s /q build
            if exist lib rmdir /s /q lib
            mkdir build
            cd build
          else
            rm -rf build lib
            mkdir build && cd build
          fi
          
          # 配置
          if [ "${{ matrix.os }}" == "windows-latest" ] && [ "${{ matrix.compiler }}" == "mingw" ]; then
            cmake -G "MinGW Makefiles" ..
            cmake --build . --config Release
          else
            cmake ..
            cmake --build . --config Release
          fi
          
          cd ..
          
          # 处理构建产物
          mkdir -p lib
          if [ "${{ matrix.os }}" == "windows-latest" ]; then
            if exist build\Release\*.dll copy build\Release\*.dll lib\ 2>nul || echo "无DLL文件"
            if exist build\Release\*.exe copy build\Release\*.exe lib\ 2>nul || echo "无可执行文件"
          else
            find build -name "*.so" -exec cp {} lib/ \; 2>/dev/null || echo "无SO文件"
            find build -name "calculator_app" -exec cp {} lib/ \; 2>/dev/null || echo "无可执行文件"
          fi

      - name: Test Executable
        run: |
          echo "=== 测试可执行文件 ==="
          if [ "${{ matrix.os }}" == "windows-latest" ]; then
            if exist lib\calculator_app.exe (
              echo "✅ 找到可执行文件，运行测试..."
              lib\calculator_app.exe
              echo "可执行文件测试完成"
            ) else (
              echo "❌ 未找到可执行文件"
            )
          else
            if [ -f "lib/calculator_app" ]; then
              echo "✅ 找到可执行文件，运行测试..."
              lib/calculator_app
              echo "可执行文件测试完成"
            else
              echo "❌ 未找到可执行文件"
            fi
          fi

      - name: Run Python interface tests
        run: |
          cd calculator_tests
          python test_interfaces.py --verbose
        env:
          PYTHONIOENCODING: utf-8

      - name: Run Comprehensive Tests
        run: |
          cd calculator_tests
          python main.py --all
          

      - name: Build Summary
        run: |
          echo "=== 构建总结 ==="
          echo "平台: ${{ matrix.os }}"
          echo "编译器: ${{ matrix.compiler }}"
          echo "库文件:"
          ls -la lib/ || dir lib\
          echo "======
          =========="