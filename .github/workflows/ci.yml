# å®šä¹‰è¿™ä¸ª workflow çš„åç§°ï¼Œåœ¨ GitHub Actions é¡µé¢ä¸­æ˜¾ç¤ºä¸º "C Calculator CI"
name: C Calculator CI

# æ¯æ¬¡ä½  git push åˆ° main/master åˆ†æ”¯ï¼Œæˆ–è€…æœ‰äººæäº¤ PR æ—¶ï¼Œéƒ½ä¼šè‡ªåŠ¨è¿è¡Œæµ‹è¯•ã€‚
on:   # å®šä¹‰ä»€ä¹ˆæ—¶å€™è§¦å‘è¿™ä¸ª workflow
  push:    # å½“ä»£ç æ¨é€åˆ°ä»¥ä¸‹åˆ†æ”¯æ—¶è§¦å‘
    branches: [ main, master ]    # æŒ‡å®šåˆ†æ”¯åç§°ï¼ˆå…¼å®¹ main å’Œ master ä¸¤ç§å‘½åï¼‰
  pull_request:    # å½“åˆ›å»ºæˆ–æ›´æ–°æ‹‰å–è¯·æ±‚åˆ°è¿™äº›åˆ†æ”¯æ—¶è§¦å‘
    branches: [ main, master ]

# GitHub ä¼šå¯åŠ¨ä¸€ä¸ªå…¨æ–°çš„ Ubuntu è™šæ‹Ÿæœºæ¥æ‰§è¡Œè¿™ä¸ª job
jobs:  # ä¸€ä¸ª workflow å¯ä»¥åŒ…å«å¤šä¸ª jobï¼Œå®ƒä»¬ä¼šå¹¶è¡Œè¿è¡Œ
  build-and-test:   # job çš„ IDï¼ˆå†…éƒ¨æ ‡è¯†ç¬¦ï¼‰
    name: Build and Test     # job çš„æ˜¾ç¤ºåç§°
    runs-on: ubuntu-latest   # åœ¨æœ€æ–°çš„ Ubuntu ç³»ç»Ÿä¸Šè¿è¡Œ

    # æŠŠä½ çš„ CProjectWithTests æ•´ä¸ªä»“åº“ä¸‹è½½åˆ°è™šæ‹Ÿæœºçš„å½“å‰ç›®å½•
    steps:
      - name: Checkout code
        uses: actions/checkout@v4    # ä½¿ç”¨åˆ«äººå†™å¥½çš„ Actionï¼ˆå¯é‡ç”¨çš„ä»£ç å—ï¼‰, GitHub å®˜æ–¹çš„ Actionï¼Œç”¨äºä¸‹è½½ä½ çš„ä»“åº“ä»£ç åˆ°è™šæ‹Ÿæœº

      - name: Install build dependencies
        run: |   # æ‰§è¡Œ shell å¤šè¡Œå‘½ä»¤: æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨; å®‰è£…è½¯ä»¶åŒ…ï¼ˆ-y è¡¨ç¤ºè‡ªåŠ¨ç¡®è®¤ï¼‰cmake gcc python3 python3-pip
          sudo apt-get update 
          sudo apt-get install -y cmake gcc python3 python3-pip

      # ç¡®ä¿ä½¿ç”¨ç‰¹å®šç‰ˆæœ¬çš„ Pythonï¼Œé¿å…ç‰ˆæœ¬å…¼å®¹é—®é¢˜
      - name: Set up Python
        uses: actions/setup-python@v4   # GitHub å®˜æ–¹çš„ Python ç¯å¢ƒè®¾ç½® Action
        with:    # å‘ Action ä¼ é€’å‚æ•°
          python-version: '3.10'   # æŒ‡å®šå®‰è£… Python 3.10

      - name: Create build directory   # å°†æ„å»ºäº§ç‰©ä¸æºä»£ç åˆ†ç¦»
        run: |
          mkdir -p build
          mkdir -p lib

      # CMake è¯»å– calculator/CMakeLists.txtï¼Œç”Ÿæˆ Makefile æˆ–å…¶ä»–æ„å»ºæ–‡ä»¶
      - name: Configure CMake
        run: cmake -B build -S calculator

      # è°ƒç”¨ GCC ç¼–è¯‘ C ä»£ç ï¼Œç”Ÿæˆå…±äº«åº“æ–‡ä»¶
      - name: Build project
        run: cmake --build build

      # ç¡®è®¤å…±äº«åº“æ˜¯å¦æˆåŠŸç”Ÿæˆ
      - name: Check built library
        run: |
          echo "æ£€æŸ¥ç”Ÿæˆçš„åº“æ–‡ä»¶:"
          ls -la lib/
          file lib/* || echo "æ²¡æœ‰åº“æ–‡ä»¶"

      # æ­¤æ—¶ Python è„šæœ¬é€šè¿‡ ctypes åŠ è½½åˆšæ‰ç¼–è¯‘çš„å…±äº«åº“ï¼Œè°ƒç”¨ C å‡½æ•°è¿›è¡Œæµ‹è¯•
      - name: Run Python tests
        run: |
          cd calculator_tests
          python test_calculator.py

      # çº¯è¾“å‡ºä¿¡æ¯æ­¥éª¤ï¼Œç”¨äºåœ¨æ—¥å¿—ä¸­æ¸…æ™°æ ‡è®°æµ‹è¯•å®Œæˆ
      - name: Test status
        run: |
          echo "ğŸ‰ æ‰€æœ‰æµ‹è¯•å®Œæˆï¼"

#  å®Œæ•´æ‰§è¡Œæµç¨‹æ€»ç»“
#  1.å‡†å¤‡ç¯å¢ƒï¼šå¯åŠ¨ Ubuntu è™šæ‹Ÿæœº â†’ ä¸‹è½½ä»£ç  â†’ å®‰è£…ä¾èµ–
#  2. ç¼–è¯‘ C ä»£ç ï¼šé…ç½® CMake â†’ ç¼–è¯‘ç”Ÿæˆå…±äº«åº“
#  3. è¿è¡Œæµ‹è¯•ï¼šPython åŠ è½½å…±äº«åº“ â†’ æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹
#  4. æŠ¥å‘Šç»“æœï¼šåœ¨ GitHub Actions é¡µé¢æ˜¾ç¤ºæˆåŠŸ/å¤±è´¥