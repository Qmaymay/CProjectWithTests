name: C Calculator CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install build dependencies (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential

      - name: Install build dependencies (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          choco install cmake -y

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Build Project
        run: |
          echo "=== 跨平台构建 ==="

          # 清理旧的构建目录
          if [ -d "build" ]; then
            rm -rf build
          fi

          # 创建构建目录
          mkdir build && cd build

          # 配置项目
          cmake ..

          # 构建项目
          cmake --build . --config Release

          # 回到根目录
          cd ..

          echo "=== 构建产物检查 ==="

          # 检查构建结果
          if [ "$RUNNER_OS" == "Windows" ]; then
            # Windows: 检查 Release 目录
            find build -name "*.dll" -o -name "*.lib" | while read file; do
              echo "📦 找到: $file"
            done

            # 复制 DLL 文件到 lib 目录
            if [ ! -d "lib" ]; then
              mkdir lib
            fi
            copy build\calculator\Release\*.dll lib\ 2>nul || echo "没有DLL文件可复制"
            copy build\Release\*.dll lib\ 2>nul || echo "没有DLL文件可复制"
          else
            # Linux: 检查常规位置
            find build -name "*.so" | while read file; do
              echo "📦 找到: $file"
            done

            # 复制 SO 文件到 lib 目录
            mkdir -p lib
            find build -name "*.so" -exec cp {} lib/ \; 2>/dev/null || true
          fi          

      - name: Run Python interface tests
        run: |
          cd calculator_tests
          python test_interfaces.py --verbose
        env:
          PYTHONIOENCODING: utf-8
